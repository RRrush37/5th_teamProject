<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="js/index.js"></script>
    <title>第五組團專</title>
    <style type="text/css">
      #txtShow {
        width: 80vw;
        height: 70vh;
      }

      #txtShow,
      #txtInput,
      #btnSend {
        display: block;
        margin: 20px auto;
      }
    </style>
  </head>
  <body>
    <!-- <div class="fullScreen">
      <div class="center">
        <div class="nickname">
          暱稱：<input type="text" id="nicknameInput" name="nickname" />
        </div>
        <div class="setNickname">設定暱稱</div>
      </div>
    </div> -->
    <p>目前房間：<span id="roomName">大廳</span></p>
    進入房間：<input type="text" id="newRoomName" />
    <input type="button" value="進入" id="enterRoom" />
    <textarea id="txtShow" disabled></textarea>
    <span style="margin: 0 auto" id="myName"></span>
    <input id="txtInput" type="text" />

    <button id="btnSend">送出</button>
    <div class="outerTimer">
      <div class="innerTimer"></div>
    </div>
    <div class="reset">重置計時器</div>
    <div class="resetQuestion">重置題目</div>
    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        let keyinDom = document.querySelector("#txtInput");
        let showDom = document.querySelector("#txtShow");
        let id;
        document.getElementById("enterRoom").addEventListener("click", () => {
          document.getElementById("roomName").innerHTML =
            document.getElementById("newRoomName").value;
        });
        document.querySelector("#btnSend").addEventListener("click", () => {
          if (keyinDom.value.trim().length === 0) {
            alert("請輸入訊息");
            return;
          }
          let txt = keyinDom.value;
          // ws.onmessage = null;
          // ws.send(txt);
          ws.send(
            JSON.stringify([
              txt,
              "text",
              id,
              document.getElementById("roomName").innerHTML,
            ])
          );
          // ws.onmessage = (event) => {
          //   let arr = JSON.parse(event.data);
          //   console.log(arr[1]);
          //   let txt;
          //   if (arr[1] === "text") {
          //     txt = arr[0];
          //     if (!showDom.value) showDom.value = txt;
          //     else showDom.value = showDom.value + "\n" + txt;
          //     keyinDom.value = "";
          //   } else if (arr[1] === "time") {
          //     document.getElementsByClassName("innerTimer")[0].style.width =
          //       arr[0] / 100 + "%";
          //   }
          // };
        });
        document
          .getElementsByClassName("resetQuestion")[0]
          .addEventListener("click", () => {
            ws.send(JSON.stringify(["", "resetQuestion"]));
          });
        document
          .getElementsByClassName("reset")[0]
          .addEventListener("click", () => {
            ws.send(JSON.stringify(["", "resetTime"]));
          });
        document.addEventListener("keydown", (e) => {
          if (
            e.keyCode === 13 &&
            document.getElementById("txtInput") === document.activeElement
          )
            document.querySelector("#btnSend").click();
        });

        // 建立 WebSocket (本例 server 端於本地運行)
        let url = "ws://192.168.50.168:3000";
        var ws = new WebSocket(url);
        // 監聽連線狀態
        ws.onopen = () => {
          console.log("open connection");
        };
        ws.onclose = () => {
          console.log("close connection");
        };
        //接收 Server 發送的訊息
        ws.onmessage = (event) => {
          let arr = JSON.parse(event.data);
          console.log(arr[0]);
          let txt;
          if (arr[1] === "ID") {
            id = arr[0];
            document.getElementById("myName").innerHTML = id + "：";
          } else if (arr[1] === "text") {
            if (arr[2] !== document.getElementById("roomName").innerHTML) {
              // alert(
              //   arr[2] + "!=" + document.getElementById("roomName").innerHTML
              // );
              return;
            }
            txt = arr[0];
            if (!showDom.value) showDom.value = txt;
            else showDom.value = showDom.value + "\n" + txt;
            keyinDom.value = "";
            if (arr[2] === id) {
              showDom.disable = true;
            }
          } else if (arr[1] === "time") {
            document.getElementsByClassName("innerTimer")[0].style.width =
              arr[0] / 100 + "%";
          }
        };
      });
    </script>
  </body>
</html>
