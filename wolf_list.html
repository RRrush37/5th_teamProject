<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="CSS/global.css" />
    <link rel="stylesheet" href="CSS/wolf/wolf_list.css" />
    <title>Wolf Room List</title>
  </head>
  <body>
    <div class="header"></div>
    <!-- 用來載入 common.html 裡頭的 header -->
    <div class="wrapper">
      <div class="activity_title">
        <svg
          width="40"
          height="40"
          viewBox="0 0 83 83"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <a href="wolf.html">
            <g filter="url(#filter0_dd_668_6)">
              <path
                d="M9 37.5L34.2778 5V23.018L74 23.0556V51.9444H34.2778V70L9 37.5Z"
                fill="#606C99"
                stroke="#606C99"
                stroke-width="10"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </g>
            <defs>
              <filter
                id="filter0_dd_668_6"
                x="0"
                y="0"
                width="83"
                height="83"
                filterUnits="userSpaceOnUse"
                color-interpolation-filters="sRGB"
              >
                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                <feColorMatrix
                  in="SourceAlpha"
                  type="matrix"
                  values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                  result="hardAlpha"
                />
                <feOffset dy="4" />
                <feGaussianBlur stdDeviation="2" />
                <feComposite in2="hardAlpha" operator="out" />
                <feColorMatrix
                  type="matrix"
                  values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"
                />
                <feBlend
                  mode="normal"
                  in2="BackgroundImageFix"
                  result="effect1_dropShadow_668_6"
                />
                <feColorMatrix
                  in="SourceAlpha"
                  type="matrix"
                  values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                  result="hardAlpha"
                />
                <feOffset dy="4" />
                <feGaussianBlur stdDeviation="2" />
                <feComposite in2="hardAlpha" operator="out" />
                <feColorMatrix
                  type="matrix"
                  values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"
                />
                <feBlend
                  mode="normal"
                  in2="effect1_dropShadow_668_6"
                  result="effect2_dropShadow_668_6"
                />
                <feBlend
                  mode="normal"
                  in="SourceGraphic"
                  in2="effect2_dropShadow_668_6"
                  result="shape"
                />
              </filter>
            </defs>
          </a>
        </svg>
  
        <h1>狼人殺</h1>
      </div>
      <section class="room_list">
        <form class="search_box">
          <input type="search" name="search" id="search" placeholder="搜尋" />
          <button type="submit" id="search_btn"></button>
        </form>
        <a href="wolf_create_room.html">
          <input type="button" name="create_room" id="create_room" value="創建房間"/>
        </a>

        <div class="room_password none">
          <article>
            <div class="close"></div>
            <p>請輸入密碼:</p>
            <p id="incorrect" class="none">密碼錯誤</p>
            <div class="password_list">
              <input type="text" class="password" name="1" maxlength="1" />
              <input type="text" class="password" name="2" maxlength="1" />
              <input type="text" class="password" name="3" maxlength="1" />
              <input type="text" class="password" name="4" maxlength="1" />
            </div>
          </article>
        </div>

        <div class="room_box">
          <div class="room">
            <span class="name" data-name="的遊戲室">狼人殺</span>
            <span class="room_number" data-roomNum="1234" data-password="5678">房號：</span>
            <span class="num" data-player="1">人數</span>
            <span class="state" data-lock="true"></span>
          </div>
        </div>
      </section>

      <!-- <div class="bottom_nav">
        <p>
          <span> 關於我們 </span>
          <span> 使用常規 </span>
          <span> 常見問題 </span>
        </p>
      </div> -->
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script
      src="https://kit.fontawesome.com/75e9abcec6.js"
      crossorigin="anonymous"
    ></script>
    <script type="module">
      import * as picture from "./JS/member_picture.js";
      $(function () {
          $(".header").load("common.html .header>div", function(){
              let user_img = document.getElementsByClassName("user")[0] ;
              picture.getMemberPicture(user_img);
          });
          $(".footer").load("common.html .footer>div");
      });
    </script>

    <script>
      
      let room_list = document.getElementsByClassName("room");
      let room_password_el = document.getElementsByClassName("room_password")[0];

      for (let i = 0; i < room_list.length; i++) {

        //加上房間設定
        room_list[i].querySelectorAll("span")[0].innerHTML = room_list[i].querySelectorAll("span")[0].innerHTML+room_list[i].querySelectorAll("span")[0].getAttribute("data-name");
        room_list[i].querySelectorAll("span")[1].innerHTML = room_list[i].querySelectorAll("span")[1].innerHTML+room_list[i].querySelectorAll("span")[1].getAttribute("data-roomNum");
        room_list[i].querySelectorAll("span")[2].innerHTML = room_list[i].querySelectorAll("span")[2].innerHTML+room_list[i].querySelectorAll("span")[2].getAttribute("data-player")+"/7";
        
        if (room_list[i].querySelectorAll("span")[3].getAttribute("data-lock") == "true" ) {
          room_list[i].querySelectorAll("span")[3].classList.add("lock") ;
        } else {
          room_list[i].querySelectorAll("span")[3].classList.add("unlock") ;
        }
        //加上房間設定

        room_list[i].addEventListener("click", function () {
          if ( room_list[i].querySelectorAll("span")[3].classList.contains("lock")) {
            room_password_el.classList.remove("none");
            room_password_el.querySelector("input").focus();

            keydownPassword( room_list[i].querySelectorAll("span")[1].getAttribute("data-password") );
          } else {
            //console.log("unlock")
          }
        });
      }


      //============================================================================燈箱

      
      let close = document.getElementsByClassName("close")[0];
      let password_list_el = document.getElementsByClassName("password_list")[0];
      let password_list = document.getElementsByClassName("password") ;
      let incorrect = document.getElementById("incorrect");

      room_password_el.addEventListener("click", function (e) {
        room_password_el.classList.add("none");
        incorrect.classList.add("none");
        for( let i = 0 ; i < password_list.length ; i++ ){
          password_list[i].value = "" ;
        }
      });

      room_password_el.querySelector("article").addEventListener("click", function (e) {
        e.stopPropagation();
      });

      close.addEventListener("click", function () {
        room_password_el.classList.add("none");
        incorrect.classList.add("none");
        for( let i = 0 ; i < password_list.length ; i++ ){
          password_list[i].value = "" ;
        }
      });

      

      function checkPassword( room_password ){
        let str = "" ;
        for( let i = 0 ; i < password_list.length ; i++ ) {
          str += password_list[i].value ;
        }

        if ( str == room_password ) {
          console.log("correct");
          window.location.href = "wolf_room.html";
        } else {
          incorrect.classList.remove("none");
        }
      }

      function keydownPassword( room_password ){
        for ( let i = 0 ; i < password_list.length ; i++ ) {
          password_list[i].addEventListener("keydown", function(e){
            if( (e.which >= 48 && e.which <= 57) || e.which == 8 ){ // 8 是刪除鍵
              if( e.which == 8 && e.target.value.length == 0 ){ //檢查是否為刪除建
                  let previous_el = e.target.previousElementSibling ;
                  previous_el.focus() ;
              }
            }else{
              e.preventDefault(); // 停止預設行為(在欄位上出現所打的文字)
            }
          })

          password_list[i].addEventListener("keyup", function(e){

            let str = e.target.value.replace(/\D/g,""); //正規表達式
            e.target.value = str ;

            if( e.target.value.length == 1 ){ //檢查是否有值
                let next_el = e.target.nextElementSibling ;
                if(next_el != null ) { // 檢查是否為最後一個，不是的話就往後移一個兄弟元素
                    next_el.focus() ;
                }
            } else {
                e.preventDefault() ;
            }

            let password = "" ;
            for( let i = 0 ; i < password_list.length ; i++ ) {
              password += password_list[i].value ;
            }

            if ( password.length == 4 ) {
              checkPassword( room_password );
            }
          })
        }
      }

      //============================================================================燈箱

    </script>
  </body>
</html>
